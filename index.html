<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VRM í¬ì¦ˆ ì—ë””í„°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            overflow: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 350px 1fr 300px;
            height: 100vh;
            gap: 0;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.2);
            max-height: 100vh;
        }

        .left-panel {
            border-right: 1px solid rgba(0, 0, 0, 0.1);
        }

        .right-panel {
            border-left: 1px solid rgba(0, 0, 0, 0.1);
        }

        .panel-content {
            padding: 20px;
            padding-bottom: 100px; /* ë§¨ ì•„ë˜ê¹Œì§€ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ë„ë¡ ì—¬ìœ  ê³µê°„ */
        }

        /* ìŠ¤í¬ë¡¤ë°” ë” ê°•ì¡° */
        .panel::-webkit-scrollbar {
            width: 12px;
        }

        .panel::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 6px;
        }

        .panel::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 6px;
            border: 2px solid #e0e0e0;
        }

        .panel::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        .panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #viewer {
            position: relative;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
        }

        #vrmCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            color: white;
            font-size: 12px;
        }

        .controls p {
            margin: 5px 0;
        }

        .file-input-wrapper {
            position: relative;
            margin-bottom: 20px;
        }

        .file-input-label {
            display: block;
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        input[type="file"] {
            display: none;
        }

        .bone-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .bone-item.finger-section {
            border-left-color: #ff6b6b;
            background: #fff5f5;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 10px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
            border-radius: 8px;
            margin-bottom: 10px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .collapsible-header:hover {
            transform: translateX(5px);
        }

        .collapsible-header .arrow {
            transition: transform 0.3s;
        }

        .collapsible-header.collapsed .arrow {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 5000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }

        .bone-name {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .slider-group {
            margin-bottom: 8px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
        }

        .slider-value {
            font-weight: bold;
            color: #764ba2;
        }

        .slider-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right, #667eea, #764ba2);
            outline: none;
            appearance: none;
        }

        input[type="number"] {
            width: 70px;
            padding: 5px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 12px;
            text-align: center;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .button {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .button-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .button-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .button-secondary {
            background: #6c757d;
            color: white;
        }

        .button-secondary:hover {
            background: #5a6268;
        }

        .button-success {
            background: #28a745;
            color: white;
        }

        .button-success:hover {
            background: #218838;
        }

        .button-danger {
            background: #dc3545;
            color: white;
        }

        .button-danger:hover {
            background: #c82333;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #667eea;
            font-size: 14px;
        }

        .input-group input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border 0.3s;
        }

        .input-group input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .pose-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .pose-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pose-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .pose-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pose-item-name {
            font-weight: bold;
            color: #333;
        }

        .pose-item-actions {
            display: flex;
            gap: 5px;
        }

        .pose-item-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .pose-item-btn.load {
            background: #667eea;
            color: white;
        }

        .pose-item-btn.delete {
            background: #dc3545;
            color: white;
        }

        .code-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            margin-top: 15px;
        }

        .section {
            margin-bottom: 25px;
        }

        .section-title {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #0d47a1;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ì™¼ìª½ íŒ¨ë„: ë³¸ ì»¨íŠ¸ë¡¤ -->
        <div class="panel left-panel">
            <div class="panel-header">ğŸ® ë³¸ ì»¨íŠ¸ë¡¤</div>
            <div class="panel-content">
                <div class="file-input-wrapper">
                    <label class="file-input-label" for="vrmFile">
                        ğŸ“ VRM íŒŒì¼ ì„ íƒ
                    </label>
                    <input type="file" id="vrmFile" accept=".vrm">
                </div>

                <div class="info-box">
                    ğŸ’¡ ìŠ¬ë¼ì´ë”ë¥¼ ì¡°ì •í•˜ì—¬ í¬ì¦ˆë¥¼ ë§Œë“œì„¸ìš”!
                </div>

                <div id="boneControls"></div>
            </div>
        </div>

        <!-- ì¤‘ì•™: 3D ë·°ì–´ -->
        <div id="viewer">
            <canvas id="vrmCanvas"></canvas>
            <div class="controls">
                <p><strong>ğŸ–±ï¸ ì¡°ì‘ë²•</strong></p>
                <p>â€¢ ë§ˆìš°ìŠ¤ ë“œë˜ê·¸: íšŒì „</p>
                <p>â€¢ íœ : ì¤Œ ì¸/ì•„ì›ƒ</p>
                <p>â€¢ ìš°í´ë¦­ ë“œë˜ê·¸: ì´ë™</p>
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½ íŒ¨ë„: ì• ë‹ˆë©”ì´ì…˜ ê´€ë¦¬ -->
        <div class="panel right-panel">
            <div class="panel-header">ğŸ¬ ì• ë‹ˆë©”ì´ì…˜ ê´€ë¦¬</div>
            <div class="panel-content">
                <div class="section">
                    <div class="section-title">ğŸ“ íŒŒì¼ ê´€ë¦¬</div>
                    <div class="file-input-wrapper">
                        <label class="file-input-label" for="jsonFile" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                            ğŸ“¥ JSON íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
                        </label>
                        <input type="file" id="jsonFile" accept=".json">
                    </div>
                    
                    <button class="button button-primary" id="saveAllJsonBtn" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                        ğŸ’¾ ëª¨ë“  ì• ë‹ˆë©”ì´ì…˜ JSON ì €ì¥
                    </button>
                </div>

                <div class="section">
                    <div class="section-title">ğŸ“ í˜„ì¬ í‚¤í”„ë ˆì„</div>
                    <div class="input-group">
                        <label>í‚¤í”„ë ˆì„ ì´ë¦„</label>
                        <input type="text" id="keyframeName" placeholder="ì˜ˆ: wave_start">
                    </div>
                    <div class="input-group">
                        <label>ì‹œê°„ (ì´ˆ)</label>
                        <input type="number" id="keyframeTime" value="0" step="0.1" min="0" placeholder="0.0">
                    </div>

                    <button class="button button-success" id="addKeyframeBtn">
                        â• í‚¤í”„ë ˆì„ ì¶”ê°€
                    </button>

                    <button class="button button-secondary" id="resetPoseBtn">
                        ğŸ”„ í¬ì¦ˆ ë¦¬ì…‹
                    </button>
                </div>

                <div class="section">
                    <div class="section-title">ğŸï¸ í‚¤í”„ë ˆì„ ëª©ë¡</div>
                    <button class="button button-danger" id="clearKeyframesBtn" style="margin-bottom: 10px;">
                        ğŸ—‘ï¸ ëª¨ë“  í‚¤í”„ë ˆì„ ì‚­ì œ
                    </button>
                    <div class="pose-list" id="keyframeList"></div>
                </div>

                <div class="section">
                    <div class="section-title">ğŸ¬ ì• ë‹ˆë©”ì´ì…˜</div>
                    <div class="input-group">
                        <label>ì• ë‹ˆë©”ì´ì…˜ ì´ë¦„</label>
                        <input type="text" id="animationName" placeholder="ì˜ˆ: wave_hand">
                    </div>

                    <button class="button button-primary" id="saveAnimationBtn">
                        ğŸ’¾ ì• ë‹ˆë©”ì´ì…˜ ì €ì¥
                    </button>

                    <button class="button button-primary" id="previewAnimationBtn" style="background: #17a2b8;">
                        â–¶ï¸ ë¯¸ë¦¬ë³´ê¸°
                    </button>
                </div>

                <div class="section">
                    <div class="section-title">ğŸ“‹ ì €ì¥ëœ ì• ë‹ˆë©”ì´ì…˜</div>
                    <div class="pose-list" id="animationList"></div>
                </div>

                <div class="section">
                    <div class="section-title">ğŸ“¤ ì½”ë“œ ë‚´ë³´ë‚´ê¸°</div>
                    <div class="warning-box">
                        âš ï¸ ì½”ë“œë¥¼ ë³µì‚¬í•˜ì—¬ ë©”ì¸ ì•±ì— ì¶”ê°€í•˜ì„¸ìš”
                    </div>
                    <button class="button button-primary" id="exportCodeBtn">
                        ğŸ“‹ JavaScript ì½”ë“œ ìƒì„±
                    </button>
                    <div class="code-output" id="codeOutput"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.164.1/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.164.1/examples/jsm/"
      }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { VRMLoaderPlugin } from 'https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@3/lib/three-vrm.module.js';

        // ê¸€ë¡œë²Œ ë³€ìˆ˜
        let scene, camera, renderer, vrm, controls, mixer, clock;
        const currentKeyframes = []; // í˜„ì¬ ì‘ì—… ì¤‘ì¸ í‚¤í”„ë ˆì„ë“¤
        const savedAnimations = []; // ì €ì¥ëœ ì• ë‹ˆë©”ì´ì…˜ë“¤

        // VRMì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ì£¼ìš” ë³¸ë“¤
        const EDITABLE_BONES = [
            'hips',
            'spine', 'chest', 'upperChest',
            'neck', 'head',
            'leftShoulder', 'leftUpperArm', 'leftLowerArm', 'leftHand',
            'rightShoulder', 'rightUpperArm', 'rightLowerArm', 'rightHand',
            'leftUpperLeg', 'leftLowerLeg', 'leftFoot',
            'rightUpperLeg', 'rightLowerLeg', 'rightFoot',
            // ì™¼ì† ì†ê°€ë½ (ê¸°ë¶€ í¬í•¨)
            'leftThumbMetacarpal', 'leftThumbProximal', 'leftThumbIntermediate', 'leftThumbDistal',
            'leftIndexMetacarpal', 'leftIndexProximal', 'leftIndexIntermediate', 'leftIndexDistal',
            'leftMiddleMetacarpal', 'leftMiddleProximal', 'leftMiddleIntermediate', 'leftMiddleDistal',
            'leftRingMetacarpal', 'leftRingProximal', 'leftRingIntermediate', 'leftRingDistal',
            'leftLittleMetacarpal', 'leftLittleProximal', 'leftLittleIntermediate', 'leftLittleDistal',
            // ì˜¤ë¥¸ì† ì†ê°€ë½ (ê¸°ë¶€ í¬í•¨)
            'rightThumbMetacarpal', 'rightThumbProximal', 'rightThumbIntermediate', 'rightThumbDistal',
            'rightIndexMetacarpal', 'rightIndexProximal', 'rightIndexIntermediate', 'rightIndexDistal',
            'rightMiddleMetacarpal', 'rightMiddleProximal', 'rightMiddleIntermediate', 'rightMiddleDistal',
            'rightRingMetacarpal', 'rightRingProximal', 'rightRingIntermediate', 'rightRingDistal',
            'rightLittleMetacarpal', 'rightLittleProximal', 'rightLittleIntermediate', 'rightLittleDistal'
        ];

        // í•œê¸€ ì´ë¦„ ë§¤í•‘
        const BONE_NAMES_KR = {
            'hips': 'ê³¨ë°˜',
            'spine': 'ì²™ì¶”',
            'chest': 'ê°€ìŠ´',
            'upperChest': 'ìƒë¶€ ê°€ìŠ´',
            'neck': 'ëª©',
            'head': 'ë¨¸ë¦¬',
            'leftShoulder': 'ì™¼ìª½ ì–´ê¹¨',
            'leftUpperArm': 'ì™¼ìª½ íŒ”ëš',
            'leftLowerArm': 'ì™¼ìª½ íŒ”ê¿ˆì¹˜',
            'leftHand': 'ì™¼ì†',
            'rightShoulder': 'ì˜¤ë¥¸ìª½ ì–´ê¹¨',
            'rightUpperArm': 'ì˜¤ë¥¸ìª½ íŒ”ëš',
            'rightLowerArm': 'ì˜¤ë¥¸ìª½ íŒ”ê¿ˆì¹˜',
            'rightHand': 'ì˜¤ë¥¸ì†',
            'leftUpperLeg': 'ì™¼ìª½ í—ˆë²…ì§€',
            'leftLowerLeg': 'ì™¼ìª½ ì¢…ì•„ë¦¬',
            'leftFoot': 'ì™¼ë°œ',
            'rightUpperLeg': 'ì˜¤ë¥¸ìª½ í—ˆë²…ì§€',
            'rightLowerLeg': 'ì˜¤ë¥¸ìª½ ì¢…ì•„ë¦¬',
            'rightFoot': 'ì˜¤ë¥¸ë°œ',
            // ì™¼ì† ì†ê°€ë½
            'leftThumbMetacarpal': 'ì™¼ì† ì—„ì§€ ê¸°ë¶€',
            'leftThumbProximal': 'ì™¼ì† ì—„ì§€ ì²«ë§ˆë””',
            'leftThumbIntermediate': 'ì™¼ì† ì—„ì§€ ì¤‘ê°„ë§ˆë””',
            'leftThumbDistal': 'ì™¼ì† ì—„ì§€ ëë§ˆë””',
            'leftIndexMetacarpal': 'ì™¼ì† ê²€ì§€ ê¸°ë¶€',
            'leftIndexProximal': 'ì™¼ì† ê²€ì§€ ì²«ë§ˆë””',
            'leftIndexIntermediate': 'ì™¼ì† ê²€ì§€ ì¤‘ê°„ë§ˆë””',
            'leftIndexDistal': 'ì™¼ì† ê²€ì§€ ëë§ˆë””',
            'leftMiddleMetacarpal': 'ì™¼ì† ì¤‘ì§€ ê¸°ë¶€',
            'leftMiddleProximal': 'ì™¼ì† ì¤‘ì§€ ì²«ë§ˆë””',
            'leftMiddleIntermediate': 'ì™¼ì† ì¤‘ì§€ ì¤‘ê°„ë§ˆë””',
            'leftMiddleDistal': 'ì™¼ì† ì¤‘ì§€ ëë§ˆë””',
            'leftRingMetacarpal': 'ì™¼ì† ì•½ì§€ ê¸°ë¶€',
            'leftRingProximal': 'ì™¼ì† ì•½ì§€ ì²«ë§ˆë””',
            'leftRingIntermediate': 'ì™¼ì† ì•½ì§€ ì¤‘ê°„ë§ˆë””',
            'leftRingDistal': 'ì™¼ì† ì•½ì§€ ëë§ˆë””',
            'leftLittleMetacarpal': 'ì™¼ì† ìƒˆë¼ ê¸°ë¶€',
            'leftLittleProximal': 'ì™¼ì† ìƒˆë¼ ì²«ë§ˆë””',
            'leftLittleIntermediate': 'ì™¼ì† ìƒˆë¼ ì¤‘ê°„ë§ˆë””',
            'leftLittleDistal': 'ì™¼ì† ìƒˆë¼ ëë§ˆë””',
            // ì˜¤ë¥¸ì† ì†ê°€ë½
            'rightThumbMetacarpal': 'ì˜¤ë¥¸ì† ì—„ì§€ ê¸°ë¶€',
            'rightThumbProximal': 'ì˜¤ë¥¸ì† ì—„ì§€ ì²«ë§ˆë””',
            'rightThumbIntermediate': 'ì˜¤ë¥¸ì† ì—„ì§€ ì¤‘ê°„ë§ˆë””',
            'rightThumbDistal': 'ì˜¤ë¥¸ì† ì—„ì§€ ëë§ˆë””',
            'rightIndexMetacarpal': 'ì˜¤ë¥¸ì† ê²€ì§€ ê¸°ë¶€',
            'rightIndexProximal': 'ì˜¤ë¥¸ì† ê²€ì§€ ì²«ë§ˆë””',
            'rightIndexIntermediate': 'ì˜¤ë¥¸ì† ê²€ì§€ ì¤‘ê°„ë§ˆë””',
            'rightIndexDistal': 'ì˜¤ë¥¸ì† ê²€ì§€ ëë§ˆë””',
            'rightMiddleMetacarpal': 'ì˜¤ë¥¸ì† ì¤‘ì§€ ê¸°ë¶€',
            'rightMiddleProximal': 'ì˜¤ë¥¸ì† ì¤‘ì§€ ì²«ë§ˆë””',
            'rightMiddleIntermediate': 'ì˜¤ë¥¸ì† ì¤‘ì§€ ì¤‘ê°„ë§ˆë””',
            'rightMiddleDistal': 'ì˜¤ë¥¸ì† ì¤‘ì§€ ëë§ˆë””',
            'rightRingMetacarpal': 'ì˜¤ë¥¸ì† ì•½ì§€ ê¸°ë¶€',
            'rightRingProximal': 'ì˜¤ë¥¸ì† ì•½ì§€ ì²«ë§ˆë””',
            'rightRingIntermediate': 'ì˜¤ë¥¸ì† ì•½ì§€ ì¤‘ê°„ë§ˆë””',
            'rightRingDistal': 'ì˜¤ë¥¸ì† ì•½ì§€ ëë§ˆë””',
            'rightLittleMetacarpal': 'ì˜¤ë¥¸ì† ìƒˆë¼ ê¸°ë¶€',
            'rightLittleProximal': 'ì˜¤ë¥¸ì† ìƒˆë¼ ì²«ë§ˆë””',
            'rightLittleIntermediate': 'ì˜¤ë¥¸ì† ìƒˆë¼ ì¤‘ê°„ë§ˆë””',
            'rightLittleDistal': 'ì˜¤ë¥¸ì† ìƒˆë¼ ëë§ˆë””'
        };

        // 3D ì”¬ ì´ˆê¸°í™”
        function initScene() {
            const canvas = document.getElementById('vrmCanvas');
            
            clock = new THREE.Clock();
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e);

            camera = new THREE.PerspectiveCamera(
                30,
                canvas.clientWidth / canvas.clientHeight,
                0.1,
                20
            );
            camera.position.set(0, 1.3, 2.5);

            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.outputEncoding = THREE.sRGBEncoding;

            // ì¡°ëª…
            const light = new THREE.DirectionalLight(0xffffff, 1.2);
            light.position.set(1, 1, 1);
            scene.add(light);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const frontLight = new THREE.DirectionalLight(0xffffff, 0.8);
            frontLight.position.set(0, 0.5, 1);
            scene.add(frontLight);

            // ê·¸ë¦¬ë“œ
            const gridHelper = new THREE.GridHelper(10, 10, 0x444444, 0x222222);
            scene.add(gridHelper);

            // OrbitControls
            controls = new OrbitControls(camera, canvas);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.target.set(0, 1, 0);
            controls.update();

            animate();

            // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ
            window.addEventListener('resize', onWindowResize);
        }

        function onWindowResize() {
            const canvas = document.getElementById('vrmCanvas');
            camera.aspect = canvas.clientWidth / canvas.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            const deltaTime = clock.getDelta();
            
            controls.update();
            if (mixer) mixer.update(deltaTime);
            if (vrm) vrm.update(deltaTime);
            renderer.render(scene, camera);
        }

        // VRM ë¡œë“œ
        async function loadVRM(file) {
            const loader = new GLTFLoader();
            loader.register((parser) => new VRMLoaderPlugin(parser));

            const url = URL.createObjectURL(file);
            
            try {
                const gltf = await loader.loadAsync(url);
                
                // ê¸°ì¡´ VRM ì œê±°
                if (vrm) {
                    scene.remove(vrm.scene);
                }

                vrm = gltf.userData.vrm;
                scene.add(vrm.scene);

                // ì‚¬ìš© ê°€ëŠ¥í•œ ë³¸ í™•ì¸
                console.log('========================================');
                console.log('ğŸ” VRM ë³¸(Bone) ëª©ë¡ í™•ì¸');
                console.log('========================================');
                
                const availableBones = [];
                const missingBones = [];
                
                EDITABLE_BONES.forEach(boneName => {
                    const bone = vrm.humanoid.getNormalizedBoneNode(boneName);
                    if (bone) {
                        availableBones.push(boneName);
                    } else {
                        missingBones.push(boneName);
                    }
                });
                
                console.log(`âœ… ì‚¬ìš© ê°€ëŠ¥í•œ ë³¸: ${availableBones.length}ê°œ`);
                console.log(`âŒ ì—†ëŠ” ë³¸: ${missingBones.length}ê°œ`);
                
                if (missingBones.length > 0) {
                    console.log('\nâš ï¸ ì´ VRM ëª¨ë¸ì— ì—†ëŠ” ë³¸ë“¤:');
                    missingBones.forEach(name => {
                        console.log(`  - ${BONE_NAMES_KR[name] || name} (${name})`);
                    });
                }
                
                console.log('========================================\n');

                // ë³¸ ì»¨íŠ¸ë¡¤ UI ìƒì„±
                createBoneControls();

                console.log('âœ… VRM ë¡œë“œ ì™„ë£Œ');
            } catch (error) {
                console.error('VRM ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('VRM íŒŒì¼ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            } finally {
                URL.revokeObjectURL(url);
            }
        }

        // ë³¸ ì»¨íŠ¸ë¡¤ UI ìƒì„±
        function createBoneControls() {
            const container = document.getElementById('boneControls');
            container.innerHTML = '';

            // ëª¨ë“  ë³¸ì„ ìˆœì„œëŒ€ë¡œ ìƒì„±
            EDITABLE_BONES.forEach(boneName => {
                const bone = vrm.humanoid.getNormalizedBoneNode(boneName);
                if (!bone) {
                    console.log(`âš ï¸ ë³¸ ì—†ìŒ: ${BONE_NAMES_KR[boneName] || boneName} (${boneName})`);
                    return;
                }

                const isFinger = boneName.includes('Thumb') || 
                                 boneName.includes('Index') || 
                                 boneName.includes('Middle') || 
                                 boneName.includes('Ring') || 
                                 boneName.includes('Little') ||
                                 boneName.includes('Metacarpal');

                if (isFinger) {
                    console.log(`âœ… ì†ê°€ë½ ë³¸ ìƒì„±: ${BONE_NAMES_KR[boneName] || boneName}`);
                }

                const boneItem = document.createElement('div');
                boneItem.className = isFinger ? 'bone-item finger-section' : 'bone-item';

                const boneNameDiv = document.createElement('div');
                boneNameDiv.className = 'bone-name';
                boneNameDiv.textContent = `${BONE_NAMES_KR[boneName] || boneName}`;
                boneItem.appendChild(boneNameDiv);

                ['x', 'y', 'z'].forEach(axis => {
                    const sliderGroup = document.createElement('div');
                    sliderGroup.className = 'slider-group';

                    const label = document.createElement('div');
                    label.className = 'slider-label';
                    label.innerHTML = `<span>${axis.toUpperCase()}</span>`;
                    sliderGroup.appendChild(label);

                    const sliderContainer = document.createElement('div');
                    sliderContainer.className = 'slider-container';

                    const slider = document.createElement('input');
                    slider.type = 'range';
                    slider.min = '-3.14';
                    slider.max = '3.14';
                    slider.step = '0.01';
                    slider.value = '0';
                    slider.id = `${boneName}-${axis}`;
                    
                    const numberInput = document.createElement('input');
                    numberInput.type = 'number';
                    numberInput.min = '-3.14';
                    numberInput.max = '3.14';
                    numberInput.step = '0.01';
                    numberInput.value = '0';
                    numberInput.id = `${boneName}-${axis}-input`;

                    slider.addEventListener('input', (e) => {
                        const value = parseFloat(e.target.value);
                        bone.rotation[axis] = value;
                        numberInput.value = value.toFixed(2);
                    });

                    numberInput.addEventListener('input', (e) => {
                        let value = parseFloat(e.target.value);
                        if (isNaN(value)) value = 0;
                        value = Math.max(-3.14, Math.min(3.14, value));
                        
                        bone.rotation[axis] = value;
                        slider.value = value;
                        numberInput.value = value.toFixed(2);
                    });

                    sliderContainer.appendChild(slider);
                    sliderContainer.appendChild(numberInput);
                    sliderGroup.appendChild(sliderContainer);
                    boneItem.appendChild(sliderGroup);
                });

                container.appendChild(boneItem);
            });

            console.log('âœ… ëª¨ë“  ë³¸ ì»¨íŠ¸ë¡¤ ìƒì„± ì™„ë£Œ!');
        }

        // í˜„ì¬ í¬ì¦ˆ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function getCurrentPoseData() {
            const poseData = {};

            EDITABLE_BONES.forEach(boneName => {
                const bone = vrm.humanoid.getNormalizedBoneNode(boneName);
                if (!bone) return;

                const rotation = bone.rotation;
                
                // 0ì´ ì•„ë‹Œ ê°’ë§Œ ì €ì¥
                if (rotation.x !== 0 || rotation.y !== 0 || rotation.z !== 0) {
                    poseData[boneName] = {
                        x: parseFloat(rotation.x.toFixed(3)),
                        y: parseFloat(rotation.y.toFixed(3)),
                        z: parseFloat(rotation.z.toFixed(3))
                    };
                }
            });

            return poseData;
        }

        // í¬ì¦ˆ ì ìš©
        function applyPose(poseData) {
            Object.entries(poseData).forEach(([boneName, rotation]) => {
                const bone = vrm.humanoid.getNormalizedBoneNode(boneName);
                if (!bone) return;

                bone.rotation.set(rotation.x, rotation.y, rotation.z);

                // ìŠ¬ë¼ì´ë” ì—…ë°ì´íŠ¸
                ['x', 'y', 'z'].forEach(axis => {
                    const slider = document.getElementById(`${boneName}-${axis}`);
                    const numberInput = document.getElementById(`${boneName}-${axis}-input`);
                    if (slider && numberInput) {
                        slider.value = rotation[axis];
                        numberInput.value = rotation[axis].toFixed(2);
                    }
                });
            });
        }

        // í¬ì¦ˆ ë¦¬ì…‹
        function resetPose() {
            if (!vrm) return;

            EDITABLE_BONES.forEach(boneName => {
                const bone = vrm.humanoid.getNormalizedBoneNode(boneName);
                if (!bone) return;

                bone.rotation.set(0, 0, 0);

                // ìŠ¬ë¼ì´ë” ë¦¬ì…‹
                ['x', 'y', 'z'].forEach(axis => {
                    const slider = document.getElementById(`${boneName}-${axis}`);
                    const numberInput = document.getElementById(`${boneName}-${axis}-input`);
                    if (slider && numberInput) {
                        slider.value = 0;
                        numberInput.value = '0.00';
                    }
                });
            });
        }

        // í‚¤í”„ë ˆì„ ì¶”ê°€
        function addKeyframe() {
            const keyframeName = document.getElementById('keyframeName').value.trim();
            const keyframeTime = parseFloat(document.getElementById('keyframeTime').value);
            
            if (!keyframeName) {
                alert('í‚¤í”„ë ˆì„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!');
                return;
            }

            if (isNaN(keyframeTime) || keyframeTime < 0) {
                alert('ì˜¬ë°”ë¥¸ ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš”! (0 ì´ìƒ)');
                return;
            }

            if (!vrm) {
                alert('ë¨¼ì € VRM íŒŒì¼ì„ ë¡œë“œí•˜ì„¸ìš”!');
                return;
            }

            const poseData = getCurrentPoseData();

            if (Object.keys(poseData).length === 0) {
                alert('í¬ì¦ˆë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”! (ìµœì†Œ í•˜ë‚˜ì˜ ë³¸ì„ ì›€ì§ì—¬ì•¼ í•©ë‹ˆë‹¤)');
                return;
            }

            // í‚¤í”„ë ˆì„ ì €ì¥
            currentKeyframes.push({
                name: keyframeName,
                time: keyframeTime,
                data: poseData
            });

            // ì‹œê°„ ìˆœìœ¼ë¡œ ì •ë ¬
            currentKeyframes.sort((a, b) => a.time - b.time);

            updateKeyframeList();
            
            // ë‹¤ìŒ í‚¤í”„ë ˆì„ì„ ìœ„í•œ ì‹œê°„ ìë™ ì¦ê°€
            document.getElementById('keyframeTime').value = (keyframeTime + 1.0).toFixed(1);
            document.getElementById('keyframeName').value = '';
            
            alert(`âœ… í‚¤í”„ë ˆì„ "${keyframeName}" (${keyframeTime}ì´ˆ)ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        }

        // í‚¤í”„ë ˆì„ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        function updateKeyframeList() {
            const keyframeList = document.getElementById('keyframeList');
            keyframeList.innerHTML = '';

            if (currentKeyframes.length === 0) {
                keyframeList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">í‚¤í”„ë ˆì„ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            currentKeyframes.forEach((keyframe, index) => {
                const keyframeItem = document.createElement('div');
                keyframeItem.className = 'pose-item';
                keyframeItem.style.borderLeftColor = '#17a2b8';

                keyframeItem.innerHTML = `
                    <div class="pose-item-header" style="flex-direction: column; align-items: flex-start; gap: 8px;">
                        <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                            <span class="pose-item-name">${keyframe.name}</span>
                            <div class="pose-item-actions">
                                <button class="pose-item-btn load" onclick="loadKeyframeByIndex(${index})" title="í¬ì¦ˆ ì ìš©">ì ìš©</button>
                                <button class="pose-item-btn delete" onclick="deleteKeyframeByIndex(${index})" title="ì‚­ì œ">ì‚­ì œ</button>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
                            <label style="font-size: 12px; color: #666;">ì‹œê°„:</label>
                            <input type="number" 
                                   value="${keyframe.time}" 
                                   step="0.1" 
                                   min="0"
                                   style="width: 80px; padding: 4px 8px; border: 2px solid #17a2b8; border-radius: 4px; font-size: 12px;"
                                   onchange="updateKeyframeTime(${index}, parseFloat(this.value))"
                                   title="í‚¤í”„ë ˆì„ ì‹œê°„ (ì´ˆ)">
                            <span style="font-size: 12px; color: #999;">ì´ˆ</span>
                        </div>
                    </div>
                `;

                keyframeList.appendChild(keyframeItem);
            });
        }

        // í‚¤í”„ë ˆì„ ì‹œê°„ ì—…ë°ì´íŠ¸
        window.updateKeyframeTime = function(index, newTime) {
            if (isNaN(newTime) || newTime < 0) {
                alert('ì˜¬ë°”ë¥¸ ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš”! (0 ì´ìƒ)');
                updateKeyframeList();
                return;
            }
            
            currentKeyframes[index].time = newTime;
            
            // ì‹œê°„ ìˆœìœ¼ë¡œ ì¬ì •ë ¬
            currentKeyframes.sort((a, b) => a.time - b.time);
            
            updateKeyframeList();
            console.log(`â±ï¸ í‚¤í”„ë ˆì„ ì‹œê°„ ì—…ë°ì´íŠ¸: ${newTime}ì´ˆ`);
        };

        // í‚¤í”„ë ˆì„ ë¶ˆëŸ¬ì˜¤ê¸°
        window.loadKeyframeByIndex = function(index) {
            if (!vrm) {
                alert('ë¨¼ì € VRM íŒŒì¼ì„ ë¡œë“œí•˜ì„¸ìš”!');
                return;
            }
            resetPose();
            applyPose(currentKeyframes[index].data);
        };

        // í‚¤í”„ë ˆì„ ì‚­ì œ
        window.deleteKeyframeByIndex = function(index) {
            if (confirm(`"${currentKeyframes[index].name}" í‚¤í”„ë ˆì„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                currentKeyframes.splice(index, 1);
                updateKeyframeList();
            }
        };

        // ëª¨ë“  í‚¤í”„ë ˆì„ ì‚­ì œ
        function clearAllKeyframes() {
            if (currentKeyframes.length === 0) {
                alert('ì‚­ì œí•  í‚¤í”„ë ˆì„ì´ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            if (confirm(`ì •ë§ë¡œ ëª¨ë“  í‚¤í”„ë ˆì„(${currentKeyframes.length}ê°œ)ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`)) {
                currentKeyframes.length = 0;
                updateKeyframeList();
                resetPose();
                alert('âœ… ëª¨ë“  í‚¤í”„ë ˆì„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                console.log('ğŸ—‘ï¸ ëª¨ë“  í‚¤í”„ë ˆì„ ì‚­ì œë¨');
            }
        }

        // ì• ë‹ˆë©”ì´ì…˜ ì €ì¥
        function saveAnimation() {
            const animationName = document.getElementById('animationName').value.trim();
            
            if (!animationName) {
                alert('ì• ë‹ˆë©”ì´ì…˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!');
                return;
            }

            if (currentKeyframes.length < 2) {
                alert('ì• ë‹ˆë©”ì´ì…˜ì„ ë§Œë“¤ë ¤ë©´ ìµœì†Œ 2ê°œì˜ í‚¤í”„ë ˆì„ì´ í•„ìš”í•©ë‹ˆë‹¤!');
                return;
            }

            // ì¤‘ë³µ ì²´í¬
            const existingIndex = savedAnimations.findIndex(a => a.name === animationName);
            if (existingIndex !== -1) {
                if (!confirm('ê°™ì€ ì´ë¦„ì˜ ì• ë‹ˆë©”ì´ì…˜ì´ ìˆìŠµë‹ˆë‹¤. ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }
                savedAnimations[existingIndex] = {
                    name: animationName,
                    keyframes: JSON.parse(JSON.stringify(currentKeyframes))
                };
            } else {
                savedAnimations.push({
                    name: animationName,
                    keyframes: JSON.parse(JSON.stringify(currentKeyframes))
                });
            }

            updateAnimationList();
            document.getElementById('animationName').value = '';
            alert(`âœ… "${animationName}" ì• ë‹ˆë©”ì´ì…˜ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        }

        // ì• ë‹ˆë©”ì´ì…˜ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        function updateAnimationList() {
            const animationList = document.getElementById('animationList');
            animationList.innerHTML = '';

            if (savedAnimations.length === 0) {
                animationList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">ì €ì¥ëœ ì• ë‹ˆë©”ì´ì…˜ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            savedAnimations.forEach((animation, index) => {
                const animationItem = document.createElement('div');
                animationItem.className = 'pose-item';

                animationItem.innerHTML = `
                    <div class="pose-item-header">
                        <span class="pose-item-name">${animation.name} (${animation.keyframes.length}ê°œ í‚¤í”„ë ˆì„)</span>
                        <div class="pose-item-actions">
                            <button class="pose-item-btn load" onclick="loadAnimationByIndex(${index})" title="í‚¤í”„ë ˆì„ ë¶ˆëŸ¬ì˜¤ê¸°">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                            <button class="pose-item-btn" onclick="saveAnimationAsJson(${index})" style="background: #28a745;" title="JSON íŒŒì¼ë¡œ ì €ì¥">ğŸ’¾</button>
                            <button class="pose-item-btn delete" onclick="deleteAnimationByIndex(${index})" title="ì‚­ì œ">ì‚­ì œ</button>
                        </div>
                    </div>
                `;

                animationList.appendChild(animationItem);
            });
        }

        // ì• ë‹ˆë©”ì´ì…˜ ë¶ˆëŸ¬ì˜¤ê¸°
        window.loadAnimationByIndex = function(index) {
            currentKeyframes.length = 0;
            currentKeyframes.push(...JSON.parse(JSON.stringify(savedAnimations[index].keyframes)));
            updateKeyframeList();
            alert(`"${savedAnimations[index].name}" ì• ë‹ˆë©”ì´ì…˜ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!`);
        };

        // ì• ë‹ˆë©”ì´ì…˜ ì‚­ì œ
        window.deleteAnimationByIndex = function(index) {
            if (confirm(`"${savedAnimations[index].name}" ì• ë‹ˆë©”ì´ì…˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                savedAnimations.splice(index, 1);
                updateAnimationList();
            }
        };

        // ì• ë‹ˆë©”ì´ì…˜ ë¯¸ë¦¬ë³´ê¸°
        function previewAnimation() {
            if (!vrm) {
                alert('ë¨¼ì € VRM íŒŒì¼ì„ ë¡œë“œí•˜ì„¸ìš”!');
                return;
            }

            if (currentKeyframes.length < 2) {
                alert('ë¯¸ë¦¬ë³´ê¸°í•˜ë ¤ë©´ ìµœì†Œ 2ê°œì˜ í‚¤í”„ë ˆì„ì´ í•„ìš”í•©ë‹ˆë‹¤!');
                return;
            }

            // ê¸°ì¡´ mixer ì •ë¦¬
            if (mixer) {
                mixer.stopAllAction();
            }
            mixer = new THREE.AnimationMixer(vrm.scene);

            // ì• ë‹ˆë©”ì´ì…˜ í´ë¦½ ìƒì„±
            const tracks = [];
            const duration = currentKeyframes[currentKeyframes.length - 1].time;

            // ê° ë³¸ë³„ë¡œ íŠ¸ë™ ìƒì„±
            const allBones = new Set();
            currentKeyframes.forEach(kf => {
                Object.keys(kf.data).forEach(boneName => allBones.add(boneName));
            });

            allBones.forEach(boneName => {
                const bone = vrm.humanoid.getNormalizedBoneNode(boneName);
                if (!bone) return;

                const times = [];
                const values = [];

                currentKeyframes.forEach(kf => {
                    times.push(kf.time);
                    
                    // ì˜¤ì¼ëŸ¬ ê°ë„ë¥¼ ì¿¼í„°ë‹ˆì–¸ìœ¼ë¡œ ë³€í™˜
                    const euler = new THREE.Euler();
                    if (kf.data[boneName]) {
                        const rot = kf.data[boneName];
                        euler.set(rot.x, rot.y, rot.z, 'XYZ');
                    } else {
                        euler.set(0, 0, 0, 'XYZ');
                    }
                    
                    const quaternion = new THREE.Quaternion();
                    quaternion.setFromEuler(euler);
                    
                    values.push(quaternion.x, quaternion.y, quaternion.z, quaternion.w);
                });

                const trackName = `${bone.name}.quaternion`;
                const track = new THREE.QuaternionKeyframeTrack(trackName, times, values);
                tracks.push(track);
            });

            const clip = new THREE.AnimationClip('preview', duration, tracks);
            const action = mixer.clipAction(clip);
            action.setLoop(THREE.LoopOnce);
            action.clampWhenFinished = true;
            action.reset().play();

            console.log('â–¶ï¸ ì• ë‹ˆë©”ì´ì…˜ ì¬ìƒ ì‹œì‘');
        }

        // ========================================
        // JSON íŒŒì¼ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
        // ========================================

        // ê°œë³„ ì• ë‹ˆë©”ì´ì…˜ì„ JSON íŒŒì¼ë¡œ ì €ì¥
        window.saveAnimationAsJson = function(index) {
            const animation = savedAnimations[index];
            
            // íŒŒì¼ëª… ì…ë ¥ ë°›ê¸°
            const fileName = prompt('ì €ì¥í•  íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:', animation.name);
            
            if (!fileName) {
                console.log('ì €ì¥ ì·¨ì†Œë¨');
                return;
            }
            
            const jsonData = {
                version: '1.0',
                type: 'vrm-animation',
                animations: [animation]
            };

            const jsonString = JSON.stringify(jsonData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${fileName}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            console.log(`ğŸ’¾ ${fileName}.json íŒŒì¼ë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤.`);
        };

        // ëª¨ë“  ì• ë‹ˆë©”ì´ì…˜ì„ JSON íŒŒì¼ë¡œ ì €ì¥
        function saveAllAnimationsAsJson() {
            if (savedAnimations.length === 0) {
                alert('ì €ì¥ëœ ì• ë‹ˆë©”ì´ì…˜ì´ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }

            // íŒŒì¼ëª… ì…ë ¥ ë°›ê¸°
            const timestamp = new Date().toISOString().slice(0, 10);
            const defaultName = `vrm_animations_${timestamp}`;
            const fileName = prompt('ì €ì¥í•  íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:', defaultName);
            
            if (!fileName) {
                console.log('ì €ì¥ ì·¨ì†Œë¨');
                return;
            }

            const jsonData = {
                version: '1.0',
                type: 'vrm-animation',
                animations: savedAnimations
            };

            const jsonString = JSON.stringify(jsonData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${fileName}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            alert(`âœ… ${savedAnimations.length}ê°œì˜ ì• ë‹ˆë©”ì´ì…˜ì„ ${fileName}.jsonìœ¼ë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤!`);
        }

        // JSON íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadAnimationsFromJson(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    
                    // ë²„ì „ ì²´í¬
                    if (!jsonData.version || !jsonData.type) {
                        throw new Error('ì˜¬ë°”ë¥¸ VRM ì• ë‹ˆë©”ì´ì…˜ JSON íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');
                    }

                    if (jsonData.type !== 'vrm-animation') {
                        throw new Error('VRM ì• ë‹ˆë©”ì´ì…˜ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');
                    }

                    // ì• ë‹ˆë©”ì´ì…˜ ë¶ˆëŸ¬ì˜¤ê¸°
                    const animations = jsonData.animations || [];
                    
                    if (animations.length === 0) {
                        alert('ì• ë‹ˆë©”ì´ì…˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    // ì¤‘ë³µ í™•ì¸ ë° ì¶”ê°€
                    let loadedCount = 0;
                    let skippedCount = 0;

                    animations.forEach(anim => {
                        const existingIndex = savedAnimations.findIndex(a => a.name === anim.name);
                        
                        if (existingIndex !== -1) {
                            if (confirm(`"${anim.name}" ì• ë‹ˆë©”ì´ì…˜ì´ ì´ë¯¸ ìˆìŠµë‹ˆë‹¤. ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                                savedAnimations[existingIndex] = anim;
                                loadedCount++;
                            } else {
                                skippedCount++;
                            }
                        } else {
                            savedAnimations.push(anim);
                            loadedCount++;
                        }
                    });

                    updateAnimationList();
                    
                    let message = `âœ… ${loadedCount}ê°œì˜ ì• ë‹ˆë©”ì´ì…˜ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!`;
                    if (skippedCount > 0) {
                        message += `\nâ­ï¸ ${skippedCount}ê°œëŠ” ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤.`;
                    }
                    alert(message);

                    console.log(`ğŸ“¥ JSON íŒŒì¼ì—ì„œ ${loadedCount}ê°œ ì• ë‹ˆë©”ì´ì…˜ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ`);

                } catch (error) {
                    console.error('JSON íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:', error);
                    alert('JSON íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n' + error.message);
                }
            };

            reader.readAsText(file);
        }

        // JavaScript ì½”ë“œ ìƒì„±
        function exportCode() {
            if (savedAnimations.length === 0) {
                alert('ì €ì¥ëœ ì• ë‹ˆë©”ì´ì…˜ì´ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }

            let code = `// ========================================
// VRM ì• ë‹ˆë©”ì´ì…˜ ì½”ë“œ (Three.js AnimationMixer ì‚¬ìš©)
// ìƒì„±ì¼: ${new Date().toLocaleString('ko-KR')}
// ========================================

`;

            // ê° ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜ ìƒì„±
            savedAnimations.forEach(animation => {
                const functionName = animation.name.replace(/[^a-zA-Z0-9_]/g, '_');
                
                code += `// ${animation.name} ì• ë‹ˆë©”ì´ì…˜ (${animation.keyframes.length}ê°œ í‚¤í”„ë ˆì„)\n`;
                code += `function createAnimation_${functionName}(vrm) {\n`;
                code += `    const mixer = new THREE.AnimationMixer(vrm.scene);\n`;
                code += `    const tracks = [];\n`;
                code += `    const duration = ${animation.keyframes[animation.keyframes.length - 1].time};\n\n`;

                // ëª¨ë“  ë³¸ ìˆ˜ì§‘
                const allBones = new Set();
                animation.keyframes.forEach(kf => {
                    Object.keys(kf.data).forEach(boneName => allBones.add(boneName));
                });

                // ê° ë³¸ë³„ë¡œ íŠ¸ë™ ìƒì„±
                allBones.forEach(boneName => {
                    code += `    // ${BONE_NAMES_KR[boneName] || boneName}\n`;
                    code += `    const ${boneName} = vrm.humanoid.getNormalizedBoneNode('${boneName}');\n`;
                    code += `    if (${boneName}) {\n`;
                    
                    const times = [];
                    const valuesData = [];
                    
                    animation.keyframes.forEach(kf => {
                        times.push(kf.time);
                        if (kf.data[boneName]) {
                            const rot = kf.data[boneName];
                            valuesData.push({ x: rot.x, y: rot.y, z: rot.z });
                        } else {
                            valuesData.push({ x: 0, y: 0, z: 0 });
                        }
                    });

                    code += `        const times_${boneName} = [${times.join(', ')}];\n`;
                    code += `        const values_${boneName} = [];\n`;
                    
                    // ì˜¤ì¼ëŸ¬ë¥¼ ì¿¼í„°ë‹ˆì–¸ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ì½”ë“œ
                    valuesData.forEach(rot => {
                        code += `        const euler_tmp = new THREE.Euler(${rot.x}, ${rot.y}, ${rot.z}, 'XYZ');\n`;
                        code += `        const quat_tmp = new THREE.Quaternion().setFromEuler(euler_tmp);\n`;
                        code += `        values_${boneName}.push(quat_tmp.x, quat_tmp.y, quat_tmp.z, quat_tmp.w);\n`;
                    });

                    code += `        const track_${boneName} = new THREE.QuaternionKeyframeTrack(\n`;
                    code += `            \`\${${boneName}.name}.quaternion\`,\n`;
                    code += `            times_${boneName},\n`;
                    code += `            values_${boneName}\n`;
                    code += `        );\n`;
                    code += `        tracks.push(track_${boneName});\n`;
                    code += `    }\n\n`;
                });

                code += `    const clip = new THREE.AnimationClip('${animation.name}', duration, tracks);\n`;
                code += `    const action = mixer.clipAction(clip);\n`;
                code += `    action.setLoop(THREE.LoopOnce);\n`;
                code += `    action.clampWhenFinished = true;\n`;
                code += `    \n`;
                code += `    return { mixer, action };\n`;
                code += `}\n\n`;
            });

            // ì• ë‹ˆë©”ì´ì…˜ ì¬ìƒ í—¬í¼ í•¨ìˆ˜
            code += `// ì• ë‹ˆë©”ì´ì…˜ ì¬ìƒ í—¬í¼\n`;
            code += `let currentMixer = null;\n\n`;
            code += `function playAnimation(vrm, animationName) {\n`;
            code += `    // ê¸°ì¡´ ì• ë‹ˆë©”ì´ì…˜ ì •ì§€\n`;
            code += `    if (currentMixer) {\n`;
            code += `        currentMixer.stopAllAction();\n`;
            code += `    }\n\n`;
            code += `    const animations = {\n`;
            savedAnimations.forEach(animation => {
                const functionName = animation.name.replace(/[^a-zA-Z0-9_]/g, '_');
                code += `        '${animation.name}': createAnimation_${functionName},\n`;
            });
            code += `    };\n\n`;
            code += `    if (animations[animationName]) {\n`;
            code += `        const { mixer, action } = animations[animationName](vrm);\n`;
            code += `        currentMixer = mixer;\n`;
            code += `        action.reset().play();\n`;
            code += `        console.log('â–¶ï¸ ì• ë‹ˆë©”ì´ì…˜ ì¬ìƒ:', animationName);\n`;
            code += `    } else {\n`;
            code += `        console.error('ì• ë‹ˆë©”ì´ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', animationName);\n`;
            code += `    }\n`;
            code += `}\n\n`;

            // animate í•¨ìˆ˜ì— ì¶”ê°€í•  ì½”ë“œ
            code += `// ========================================\n`;
            code += `// animate í•¨ìˆ˜ì— ë‹¤ìŒ ì½”ë“œë¥¼ ì¶”ê°€í•˜ì„¸ìš”:\n`;
            code += `// ========================================\n`;
            code += `// const deltaTime = clock.getDelta();\n`;
            code += `// if (currentMixer) currentMixer.update(deltaTime);\n\n`;

            // ì‚¬ìš© ì˜ˆì‹œ
            code += `// ========================================\n`;
            code += `// ì‚¬ìš© ì˜ˆì‹œ:\n`;
            code += `// ========================================\n`;
            code += `// playAnimation(vrm, '${savedAnimations[0].name}');\n`;

            document.getElementById('codeOutput').textContent = code;
            alert('âœ… ì½”ë“œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ì•„ë˜ ì½”ë“œë¥¼ ë³µì‚¬í•˜ì„¸ìš”.');
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('vrmFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) loadVRM(file);
        });

        document.getElementById('jsonFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) loadAnimationsFromJson(file);
        });

        document.getElementById('saveAllJsonBtn').addEventListener('click', saveAllAnimationsAsJson);
        document.getElementById('addKeyframeBtn').addEventListener('click', addKeyframe);
        document.getElementById('resetPoseBtn').addEventListener('click', resetPose);
        document.getElementById('clearKeyframesBtn').addEventListener('click', clearAllKeyframes);
        document.getElementById('saveAnimationBtn').addEventListener('click', saveAnimation);
        document.getElementById('previewAnimationBtn').addEventListener('click', previewAnimation);
        document.getElementById('exportCodeBtn').addEventListener('click', exportCode);

        // ì´ˆê¸°í™”
        initScene();
        updateKeyframeList();
        updateAnimationList();

    </script>
</body>
</html>